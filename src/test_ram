import os
import time
import ampl_solver  # Importamos nuestro módulo
import random

# --- Configura tus rutas aquí ---
BASE_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), '..'))
DAT_DIR = os.path.join(BASE_DIR, 'data', 'instances_dat')
MODELS_DIR = os.path.join(BASE_DIR, 'models')
# ---------------------------------

# --- PARÁMETROS DE LA PRUEBA ---
INSTANCE_NAME = "2000x2000_1"
MODEL_MODE = "MS"
N_CENTROS_A_ABRIR = 100
N_TOTAL_LOCACIONES = 2000 # Asegúrate que esto coincida con la instancia
# ---------------------------------

def run_test():
    print(f"--- Iniciando Prueba de RAM ---")
    print(f"Instancia: {INSTANCE_NAME} (Modo: {MODEL_MODE})")
    
    # 1. Definir rutas de archivos
    dat_file = os.path.join(DAT_DIR, f"{INSTANCE_NAME}.dat")
    
    if MODEL_MODE == "SS":
        mod_file = os.path.join(MODELS_DIR, 'CFLP_SingleSource.mod')
    else:
        mod_file = os.path.join(MODELS_DIR, 'CFLP_MultiSource.mod')

    if not os.path.exists(dat_file):
        print(f"Error: No se encuentra {dat_file}. Asegúrate de haberlo parseado primero.")
        print("Puedes correr: python src/main.py -a parse")
        return
    if not os.path.exists(mod_file):
        print(f"Error: No se encuentra {mod_file}.")
        return

    # 2. Crear el vector de centros abiertos (como dijo tu profesor)
    print(f"Creando vector de prueba con {N_CENTROS_A_ABRIR} centros abiertos...")
    
    # Opción: Abrir 1000 al azar (más realista)
    all_locs = list(range(1, N_TOTAL_LOCACIONES + 1))
    open_facilities_list = random.sample(all_locs, N_CENTROS_A_ABRIR)
    
    print(f"Vector creado. Primeros 10 centros de prueba: {open_facilities_list[:10]}...")

    # 3. Llamar a la función de AMPL
    print(f"Llamando a AMPL (solve_assignment_and_get_solution)...")
    print("Esto probará la carga de datos y la resolución del subproblema.")
    
    start_time = time.time()
    
    # Esta función (solve_assignment_and_get_solution) es la que:
    # 1. Carga el .dat
    # 2. Fija la variable 'x' (localizaciones)
    # 3. Resuelve para 'y' (asignaciones)
    costo, asignaciones = ampl_solver.solve_assignment_and_get_solution(
        dat_file_path=dat_file,
        mod_file_path=mod_file,
        open_facilities_indices=open_facilities_list,
        mode=MODEL_MODE
    )
    
    end_time = time.time()
    
    print(f"\n--- Prueba Finalizada ---")
    print(f"Tiempo total de AMPL: {end_time - start_time:.2f} segundos")
    
    if costo and asignaciones:
        print(f"¡ÉXITO! Se resolvió la asignación.")
        print(f"Costo Total: {costo:,.2f}")
        print(f"Total Asignaciones encontradas: {len(asignaciones)}")
        print(f"Ejemplo de asignación: {asignaciones[0]}")
    else:
        print(f"FALLO. La función no devolvió resultados. Revisa el log de Gurobi/AMPL.")

if __name__ == "__main__":
    run_test()